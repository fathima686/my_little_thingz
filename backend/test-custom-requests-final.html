<!DOCTYPE html>
<html>
<head>
    <title>Test Custom Requests API - Final</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .request-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin: 10px 0; background: #f9fafb; }
        .request-header { font-weight: bold; color: #1f2937; margin-bottom: 10px; }
        .request-details { color: #6b7280; font-size: 14px; }
        .images { display: flex; gap: 10px; margin: 10px 0; }
        .images img { width: 100px; height: 80px; object-fit: cover; border-radius: 4px; }
        #output { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; min-height: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Custom Requests API - Final</h1>
        
        <div>
            <button onclick="runExecuteFix()">Execute Complete Fix</button>
            <button onclick="testAPI()">Test API</button>
            <button onclick="testPendingRequests()">Test Pending Requests</button>
            <button onclick="testAllRequests()">Test All Requests</button>
        </div>
        
        <div id="output">Click "Execute Complete Fix" first, then test the API...</div>
    </div>

    <script>
        async function runExecuteFix() {
            document.getElementById('output').innerHTML = '<p class="info">üîÑ Running complete fix...</p>';
            
            try {
                const response = await fetch('execute-custom-requests-fix.php');
                const text = await response.text();
                
                // Convert plain text to HTML
                const htmlOutput = text
                    .replace(/\n/g, '<br>')
                    .replace(/‚úì/g, '<span class="success">‚úì</span>')
                    .replace(/‚ùå/g, '<span class="error">‚ùå</span>')
                    .replace(/===/g, '<strong>')
                    .replace(/Step \d+:/g, '<h3 class="info">$&</h3>');
                
                document.getElementById('output').innerHTML = htmlOutput;
            } catch (error) {
                document.getElementById('output').innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        async function testAPI() {
            document.getElementById('output').innerHTML = '<p class="info">üß™ Testing API...</p>';
            
            try {
                const response = await fetch('api/admin/custom-requests-database-only.php?status=all');
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = `
                        <div class="success">
                            <h3>‚úÖ API Test Successful!</h3>
                            <p><strong>Total Requests:</strong> ${data.total_count}</p>
                            <p><strong>Showing:</strong> ${data.showing_count}</p>
                            <p><strong>API Version:</strong> ${data.api_version}</p>
                            <p><strong>Message:</strong> ${data.message}</p>
                        </div>
                    `;
                    
                    if (data.stats) {
                        html += `
                            <div class="info">
                                <h4>üìä Statistics:</h4>
                                <ul>
                                    <li>Total: ${data.stats.total_requests}</li>
                                    <li>Pending: ${data.stats.pending_requests}</li>
                                    <li>In Progress: ${data.stats.in_progress_requests}</li>
                                    <li>Completed: ${data.stats.completed_requests}</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (data.requests && data.requests.length > 0) {
                        html += '<h4>üìã Sample Requests:</h4>';
                        data.requests.slice(0, 3).forEach(req => {
                            html += `
                                <div class="request-card">
                                    <div class="request-header">${req.title}</div>
                                    <div class="request-details">
                                        <strong>Customer:</strong> ${req.customer_name} (${req.customer_email})<br>
                                        <strong>Status:</strong> ${req.status}<br>
                                        <strong>Description:</strong> ${req.description}<br>
                                        <strong>Requirements:</strong> ${req.requirements}
                                    </div>
                                    ${req.images && req.images.length > 0 ? `
                                        <div class="images">
                                            ${req.images.slice(0, 2).map(img => `<img src="${img}" alt="Request image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNkI3MjgwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZTwvdGV4dD4KPHN2Zz4K'">`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    document.getElementById('output').innerHTML = html;
                } else {
                    document.getElementById('output').innerHTML = `<p class="error">‚ùå API Error: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('output').innerHTML = `<p class="error">‚ùå Test Error: ${error.message}</p>`;
            }
        }
        
        async function testPendingRequests() {
            document.getElementById('output').innerHTML = '<p class="info">üîç Testing pending requests...</p>';
            
            try {
                const response = await fetch('api/admin/custom-requests-database-only.php?status=pending');
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('output').innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Pending Requests Test Successful!</h3>
                            <p><strong>Pending Requests:</strong> ${data.showing_count}</p>
                            <p><strong>Filter Applied:</strong> ${data.filter_applied}</p>
                            <p><strong>Message:</strong> ${data.message}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('output').innerHTML = `<p class="error">‚ùå Pending Test Error: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('output').innerHTML = `<p class="error">‚ùå Pending Test Error: ${error.message}</p>`;
            }
        }
        
        async function testAllRequests() {
            document.getElementById('output').innerHTML = '<p class="info">üìã Testing all requests...</p>';
            
            try {
                const response = await fetch('api/admin/custom-requests-database-only.php?status=all');
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = `
                        <div class="success">
                            <h3>‚úÖ All Requests Test Successful!</h3>
                            <p><strong>Total Requests:</strong> ${data.total_count}</p>
                        </div>
                        <h4>üìã All Requests:</h4>
                    `;
                    
                    if (data.requests && data.requests.length > 0) {
                        data.requests.forEach(req => {
                            html += `
                                <div class="request-card">
                                    <div class="request-header">${req.title} - ${req.status.toUpperCase()}</div>
                                    <div class="request-details">
                                        <strong>Customer:</strong> ${req.customer_name}<br>
                                        <strong>Email:</strong> ${req.customer_email}<br>
                                        <strong>Phone:</strong> ${req.customer_phone || 'N/A'}<br>
                                        <strong>Occasion:</strong> ${req.occasion || 'General'}<br>
                                        <strong>Budget:</strong> $${req.budget_min} - $${req.budget_max}<br>
                                        <strong>Deadline:</strong> ${req.deadline}<br>
                                        <strong>Description:</strong> ${req.description}<br>
                                        <strong>Requirements:</strong> ${req.requirements}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p class="warning">No requests found.</p>';
                    }
                    
                    document.getElementById('output').innerHTML = html;
                } else {
                    document.getElementById('output').innerHTML = `<p class="error">‚ùå All Requests Error: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('output').innerHTML = `<p class="error">‚ùå All Requests Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>