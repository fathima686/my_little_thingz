<!DOCTYPE html>
<html>
<head>
    <title>Debug Frontend Subscription</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { background: #6b46c1; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #553c9a; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .result { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .highlight { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Frontend Subscription Issue</h1>
        <p>Testing exactly what the frontend receives from subscription APIs</p>
        
        <div class="test-section">
            <h3>1. Test Profile API (What Frontend Calls)</h3>
            <button class="btn" onclick="testProfileAPI()">Test Profile API</button>
            <div id="profile-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Test Subscription Status API</h3>
            <button class="btn" onclick="testSubscriptionStatusAPI()">Test Subscription Status API</button>
            <div id="subscription-status-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Simulate Frontend Logic</h3>
            <button class="btn" onclick="simulateFrontendLogic()">Simulate Frontend Logic</button>
            <div id="frontend-logic-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. Test Tutorial Access Logic</h3>
            <button class="btn" onclick="testTutorialAccessLogic()">Test Tutorial Access Logic</button>
            <div id="tutorial-logic-result" class="result"></div>
        </div>
        
        <script>
        const API_BASE = 'http://localhost/my_little_thingz/backend/api';
        const userEmail = 'soudhame52@gmail.com';
        
        async function testProfileAPI() {
            const resultDiv = document.getElementById('profile-result');
            resultDiv.innerHTML = 'Testing profile API (what frontend calls)...';
            
            try {
                const response = await fetch(`${API_BASE}/customer/profile.php`, {
                    method: 'GET',
                    headers: {
                        'X-Tutorial-Email': userEmail
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    const planCode = data.subscription?.plan_code || data.plan_code || 'basic';
                    const isActive = data.subscription?.is_active;
                    const subscriptionStatus = data.subscription?.subscription_status;
                    
                    resultDiv.innerHTML = `‚úÖ Profile API Response:

üéØ FRONTEND WILL SEE:
Plan Code: ${planCode} ${planCode === 'pro' ? '‚úÖ' : '‚ùå'}
Is Active: ${isActive} ${isActive ? '‚úÖ' : '‚ùå'}
Subscription Status: ${subscriptionStatus}

üîç SUBSCRIPTION OBJECT:
${JSON.stringify(data.subscription, null, 2)}

üîç FEATURE ACCESS:
${JSON.stringify(data.feature_access, null, 2)}

üîç FULL RESPONSE:
${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `‚ùå ERROR: ${response.status} ${response.statusText}\n\nResponse:\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå NETWORK ERROR: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testSubscriptionStatusAPI() {
            const resultDiv = document.getElementById('subscription-status-result');
            resultDiv.innerHTML = 'Testing subscription status API...';
            
            try {
                const response = await fetch(`${API_BASE}/customer/subscription-status.php`, {
                    method: 'GET',
                    headers: {
                        'X-Tutorial-Email': userEmail
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    resultDiv.innerHTML = `‚úÖ Subscription Status API Response:

Plan Code: ${data.plan_code} ${data.plan_code === 'pro' ? '‚úÖ' : '‚ùå'}
Is Active: ${data.is_active} ${data.is_active ? '‚úÖ' : '‚ùå'}
Subscription Status: ${data.subscription_status}

üîç FEATURE ACCESS:
${JSON.stringify(data.feature_access, null, 2)}

üîç FULL RESPONSE:
${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `‚ùå ERROR: ${response.status} ${response.statusText}\n\nResponse:\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå NETWORK ERROR: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function simulateFrontendLogic() {
            const resultDiv = document.getElementById('frontend-logic-result');
            resultDiv.innerHTML = 'Simulating frontend subscription logic...';
            
            try {
                // Simulate exactly what the frontend does
                const res = await fetch(`${API_BASE}/customer/profile.php`, {
                    headers: {
                        'X-Tutorial-Email': userEmail
                    }
                });
                const data = await res.json();
                
                console.log('Subscription status response:', data);
                
                let subscriptionStatus = null;
                let subscriptionPlan = 'basic';
                
                if (data.status === 'success') {
                    subscriptionStatus = data;
                    
                    // FIXED: Get subscription plan from the correct path
                    const currentPlan = data.subscription?.plan_code || data.plan_code || 'basic';
                    subscriptionPlan = currentPlan;
                    
                    console.log('Subscription status set:', {
                        plan_code: currentPlan,
                        subscription_data: data.subscription,
                        feature_access: data.feature_access,
                        can_access_live_workshops: data.feature_access?.access_levels?.can_access_live_workshops,
                        frontend_plan_state: currentPlan
                    });
                }
                
                resultDiv.innerHTML = `üéØ FRONTEND LOGIC SIMULATION:

Step 1: API Call Success: ${data.status === 'success' ? '‚úÖ' : '‚ùå'}

Step 2: Plan Detection:
- data.subscription?.plan_code: ${data.subscription?.plan_code || 'undefined'}
- data.plan_code: ${data.plan_code || 'undefined'}
- Final subscriptionPlan: ${subscriptionPlan} ${subscriptionPlan === 'pro' ? '‚úÖ' : '‚ùå'}

Step 3: Feature Access Check:
- subscriptionStatus.feature_access: ${subscriptionStatus?.feature_access ? '‚úÖ EXISTS' : '‚ùå MISSING'}
- can_access_unlimited_tutorials: ${subscriptionStatus?.feature_access?.access_levels?.can_access_unlimited_tutorials ? '‚úÖ' : '‚ùå'}
- can_download_videos: ${subscriptionStatus?.feature_access?.access_levels?.can_download_videos ? '‚úÖ' : '‚ùå'}

Step 4: Tutorial Access Logic:
- Plan is Pro: ${subscriptionPlan === 'pro' ? '‚úÖ' : '‚ùå'}
- Subscription is Active: ${subscriptionStatus?.subscription?.is_active ? '‚úÖ' : '‚ùå'}
- Has Unlimited Access: ${subscriptionStatus?.feature_access?.access_levels?.can_access_unlimited_tutorials ? '‚úÖ' : '‚ùå'}

üîç WHAT FRONTEND SEES:
subscriptionPlan: "${subscriptionPlan}"
subscriptionStatus: ${JSON.stringify(subscriptionStatus, null, 2)}`;
                
                resultDiv.className = subscriptionPlan === 'pro' ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå SIMULATION ERROR: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testTutorialAccessLogic() {
            const resultDiv = document.getElementById('tutorial-logic-result');
            resultDiv.innerHTML = 'Testing tutorial access logic...';
            
            try {
                // Get subscription status first
                const res = await fetch(`${API_BASE}/customer/profile.php`, {
                    headers: {
                        'X-Tutorial-Email': userEmail
                    }
                });
                const subscriptionStatus = await res.json();
                
                // Simulate hasAccessToTutorial function
                const mockTutorial = {
                    id: 1,
                    title: 'Test Tutorial',
                    is_free: false,
                    price: 299
                };
                
                const mockPurchases = new Set(); // Empty purchases
                
                // Simulate the exact logic from TutorialsDashboard
                function hasAccessToTutorial(tutorial) {
                    // Free tutorials are always accessible
                    if (tutorial.is_free || tutorial.price === 0) {
                        return { access: true, reason: 'FREE' };
                    }
                    
                    // Check if individually purchased
                    if (mockPurchases.has(tutorial.id)) {
                        return { access: true, reason: 'PURCHASED' };
                    }
                    
                    // Use feature access control - unlimited tutorials require Premium or Pro
                    if (subscriptionStatus?.feature_access) {
                        const canAccessUnlimited = subscriptionStatus.feature_access.access_levels?.can_access_unlimited_tutorials;
                        
                        if (canAccessUnlimited && 
                            (subscriptionStatus.subscription?.plan_code === 'premium' || subscriptionStatus.subscription?.plan_code === 'pro') &&
                            (subscriptionStatus.subscription?.is_active || subscriptionStatus.subscription?.subscription_status === 'pending' || subscriptionStatus.subscription?.subscription_status === 'authenticated')) {
                            return { 
                                access: true, 
                                reason: 'SUBSCRIPTION',
                                plan: subscriptionStatus.subscription?.plan_code,
                                status: subscriptionStatus.subscription?.subscription_status
                            };
                        }
                    }
                    
                    return { 
                        access: false, 
                        reason: 'DENIED',
                        debug: {
                            is_free: tutorial.is_free,
                            price: tutorial.price,
                            purchased: mockPurchases.has(tutorial.id),
                            subscription_active: subscriptionStatus?.subscription?.is_active,
                            plan_code: subscriptionStatus?.subscription?.plan_code,
                            can_access_unlimited: subscriptionStatus?.feature_access?.access_levels?.can_access_unlimited_tutorials
                        }
                    };
                }
                
                const accessResult = hasAccessToTutorial(mockTutorial);
                
                resultDiv.innerHTML = `üéØ TUTORIAL ACCESS LOGIC TEST:

Tutorial: "${mockTutorial.title}" (‚Çπ${mockTutorial.price})
Access Result: ${accessResult.access ? '‚úÖ GRANTED' : '‚ùå DENIED'}
Reason: ${accessResult.reason}

üîç ACCESS CHECK DETAILS:
${JSON.stringify(accessResult, null, 2)}

üîç SUBSCRIPTION DATA USED:
Plan Code: ${subscriptionStatus?.subscription?.plan_code}
Is Active: ${subscriptionStatus?.subscription?.is_active}
Subscription Status: ${subscriptionStatus?.subscription?.subscription_status}
Can Access Unlimited: ${subscriptionStatus?.feature_access?.access_levels?.can_access_unlimited_tutorials}

${accessResult.access ? '‚úÖ TUTORIAL SHOULD BE UNLOCKED' : '‚ùå TUTORIAL WILL BE LOCKED'}`;
                
                resultDiv.className = accessResult.access ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå LOGIC TEST ERROR: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        </script>
    </div>
</body>
</html>